<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Basic Conversation 1</title>
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Open Sans', sans-serif;
  background: #fafafa;
  color: #111;
  padding: 20px;
  max-width: 900px;
  margin: auto;
  line-height: 1.6;
}

h1 {
  font-size: 26px;
  text-align: center;
  color: #0b69ff;
  margin-bottom: 10px;
}

h2 {
  font-size: 20px;
  margin-top: 30px;
  padding-bottom: 8px;
  border-bottom: 2px solid #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
}

.section-controls {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

button {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: background 0.3s ease;
}

button.play { background: #0b69ff; color: #fff; }
button.slow { background: #5aa0ff; color: #fff; }
button.repeat { background: #17a34a; color: #fff; }
button.download { background: #555; color: #fff; }
button.download.done { background: #17a34a; }
button.quiz { background: #04695c; color: #fff; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

th, td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #eee;
}

td.pt { font-weight: 600; width: 45%; }
td.en { width: 45%; color: #555; }
td.actions { width: 10%; text-align: center; }

.progress-message {
  font-size: 14px;
  color: #0b69ff;
  margin-top: 6px;
}

.quiz-box {
  margin-top: 15px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #fff;
}

.quiz-question {
  font-weight: 600;
  margin-bottom: 10px;
}

.quiz-options {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.quiz-options button {
  background: #0b69ff;
  color: white;
}

.quiz-options button.correct { background: #17a34a; }
.quiz-options button.wrong { background: #e53935; }
</style>
</head>
<body>
  <h1>Basic Conversation 1</h1>
  <p style="text-align:center; color:#444; max-width:700px; margin:auto;">
    Practice introductory European Portuguese conversation phrases.<br>
    Choose a section to listen, repeat, or test yourself â€” or take a global quiz for everything!
  </p>

  <!-- Global quiz controls -->
  <div style="text-align:center; margin:20px 0;">
    <button class="quiz" id="globalQuizBtn">ðŸŽ“ Quiz All Sections</button>
    <div id="globalQuizMode" style="margin-top:10px;"></div>
    <div id="globalQuizBox"></div>
  </div>

  <div id="phrasebook"></div>

  <!-- JSZip + FileSaver for downloads -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
  const sections = [
    { title: 'Greetings', phrases: [
      {id:'p1', pt:'OlÃ¡', en:'Hello'},
      {id:'p2', pt:'Oi', en:'Hi'}
    ]},
    { title: 'Times of Day', phrases: [
      {id:'p3', pt:'Bom dia', en:'Good morning'},
      {id:'p4', pt:'Boa tarde', en:'Good afternoon'},
      {id:'p5', pt:'Boa noite', en:'Good evening / Good night'}
    ]},
    { title: 'How Are You?', phrases: [
      {id:'p6', pt:'Tudo bem?', en:'All good? / How are you?'},
      {id:'p7', pt:'Sim, tudo bem. E contigo?', en:'Yes, all good. And you?'},
      {id:'p8', pt:'TambÃ©m estÃ¡ tudo bem', en:'Everything\'s good too'},
      {id:'p9', pt:'Como estÃ¡s?', en:'How are you?'},
      {id:'p10', pt:'Estou bem. E tu?', en:'I\'m fine. And you?'},
      {id:'p11', pt:'TambÃ©m estou bem', en:'I\'m fine too'}
    ]},
    { title: 'Names & Introductions', phrases: [
      {id:'p12', pt:'Como te chamas?', en:'What\'s your name?'},
      {id:'p13', pt:'Chamo-me...', en:'My name is...'},
      {id:'p14', pt:'Eu sou o...', en:'I\'m (male)...'},
      {id:'p15', pt:'Qual Ã© o teu nome?', en:'What\'s your name?'},
      {id:'p16', pt:'O meu nome Ã©...', en:'My name is...'}
    ]},
    { title: 'Meeting Someone', phrases: [
      {id:'p17', pt:'Prazer', en:'Pleasure'},
      {id:'p18', pt:'Muito prazer', en:'Nice to meet you'},
      {id:'p19', pt:'Prazer em te conhecer', en:'Nice to meet you'}
    ]},
    { title: "Where You're From & Where You Live", phrases: [
      {id:'p20', pt:'De onde Ã©s?', en:'Where are you from?'},
      {id:'p21', pt:'Eu sou da AmÃ©rica', en:'I\'m from America'},
      {id:'p22', pt:'Eu sou da Ãfrica do Sul', en:'I\'m from South Africa'},
      {id:'p23', pt:'Onde vives?', en:'Where do you live?'},
      {id:'p24', pt:'Eu vivo no Estoril', en:'I live in Estoril'},
      {id:'p25', pt:'Eu vivo em Cascais', en:'I live in Cascais'}
    ]},
    { title: 'Age', phrases: [
      {id:'p26', pt:'Quantos anos tens?', en:'How old are you?'},
      {id:'p27', pt:'Eu tenho cinquenta e quatro anos', en:'I\'m fifty-four years old'},
      {id:'p28', pt:'Eu tenho cinquenta e trÃªs anos', en:'I\'m fifty-three years old'}
    ]},
    { title: 'Work', phrases: [
      {id:'p29', pt:'Qual Ã© o teu trabalho?', en:'What\'s your job?'},
      {id:'p30', pt:'Eu trabalho em operaÃ§Ãµes e tecnologia', en:'I work in operations and technology'},
      {id:'p31', pt:'Eu sou reformado', en:'I\'m retired'}
    ]},
    { title: 'Likes & Activities', phrases: [
      {id:'p32', pt:'O que Ã© que gostas de fazer?', en:'What do you like to do?'},
      {id:'p33', pt:'Eu gosto de ir Ã  praia', en:'I like going to the beach'},
      {id:'p34', pt:'Eu gosto de comer fora', en:'I like eating out'}
    ]}
  ];
  const container = document.getElementById('phrasebook');

  sections.forEach(section => {
    const secDiv = document.createElement('div');
    const h2 = document.createElement('h2');
    const titleSpan = document.createElement('span');
    titleSpan.textContent = section.title;
    h2.appendChild(titleSpan);

    const controls = document.createElement('div');
    controls.className = 'section-controls';

    const repeatBtn = document.createElement('button');
    repeatBtn.className = 'repeat';
    repeatBtn.textContent = 'Listen & Repeat Section';
    repeatBtn.addEventListener('click', () => repeatSection(section));
    controls.appendChild(repeatBtn);

    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'download';
    downloadBtn.textContent = 'Download Section Audio';
    downloadBtn.addEventListener('click', () => downloadSection(section, h2));
    controls.appendChild(downloadBtn);

    const quizBtn = document.createElement('button');
    quizBtn.className = 'quiz';
    quizBtn.textContent = 'Quiz Section';
    quizBtn.addEventListener('click', () => showQuizModeSelector(section, secDiv));
    controls.appendChild(quizBtn);

    h2.appendChild(controls);

    const progressMsg = document.createElement('div');
    progressMsg.className = 'progress-message';
    secDiv.appendChild(h2);
    secDiv.appendChild(progressMsg);

    // Create table
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>PortuguÃªs</th><th>English</th><th>Actions</th></tr>';
    table.appendChild(thead);
    const tbody = document.createElement('tbody');

    section.phrases.forEach(ph => {
      const tr = document.createElement('tr');
      const tdPt = document.createElement('td');
      tdPt.className = 'pt';
      tdPt.textContent = ph.pt;

      const tdEn = document.createElement('td');
      tdEn.className = 'en';
      tdEn.textContent = ph.en;

      const tdActions = document.createElement('td');
      tdActions.className = 'actions';

      const playBtn = document.createElement('button');
      playBtn.className = 'play';
      playBtn.textContent = 'Play';
      playBtn.addEventListener('click', () => playAudio(ph.id, 1));
      tdActions.appendChild(playBtn);

      const slowBtn = document.createElement('button');
      slowBtn.className = 'slow';
      slowBtn.textContent = 'Slow';
      slowBtn.addEventListener('click', () => playAudio(ph.id, 0.8));
      tdActions.appendChild(slowBtn);

      tr.appendChild(tdPt);
      tr.appendChild(tdEn);
      tr.appendChild(tdActions);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    secDiv.appendChild(table);

    const quizBox = document.createElement('div');
    quizBox.className = 'quiz-box';
    quizBox.style.display = 'none';
    secDiv.appendChild(quizBox);

    container.appendChild(secDiv);
  });

  // --- Audio & Repeat Functions ---
  function playAudio(id, rate = 1) {
    const audio = new Audio('audio/' + id + '.mp3');
    audio.playbackRate = rate;
    audio.play();
  }

  function repeatSection(section) {
    let i = 0;
    function playNext() {
      if (i < section.phrases.length) {
        playAudio(section.phrases[i].id);
        i++;
        setTimeout(playNext, 3000);
      }
    }
    playNext();
  }
  // --- QUIZ SYSTEM ---

  // Show quiz mode selector (for section or global)
  function showQuizModeSelector(section, parentDiv = null, global = false) {
    const modeContainer = document.createElement('div');
    modeContainer.style.margin = '10px 0';
    modeContainer.innerHTML = `
      <strong>Select quiz mode:</strong><br>
      <button class="quiz" data-mode="pt-en">ðŸ‡µðŸ‡¹ Portuguese â†’ English</button>
      <button class="quiz" data-mode="en-pt">ðŸ‡¬ðŸ‡§ English â†’ Portuguese</button>
      <button class="quiz" data-mode="mix">ðŸ”„ Mixed</button>
    `;

    // Determine where to show the selector
    if (global) {
      const globalModeDiv = document.getElementById('globalQuizMode');
      globalModeDiv.innerHTML = '';
      globalModeDiv.appendChild(modeContainer);
    } else {
      // Section quiz
      const existing = parentDiv.querySelector('.quiz-mode-container');
      if (existing) existing.remove();
      modeContainer.classList.add('quiz-mode-container');
      parentDiv.insertBefore(modeContainer, parentDiv.querySelector('.quiz-box'));
    }

    // Add listeners to start quiz
    modeContainer.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.mode;
        modeContainer.remove();
        if (global) {
          startQuizMode(mode, flattenSections(sections), document.getElementById('globalQuizBox'));
        } else {
          startQuizMode(mode, section.phrases, parentDiv.querySelector('.quiz-box'));
        }
      });
    });
  }

  // Helper: flatten all sections into one list
  function flattenSections(arr) {
    return arr.flatMap(s => s.phrases);
  }

  // Start quiz based on mode and list of phrases
  function startQuizMode(mode, phrases, container) {
    container.style.display = 'block';
    container.innerHTML = '';
    let current = 0;
    let score = 0;

    const shuffled = [...phrases].sort(() => Math.random() - 0.5);

    const questionDiv = document.createElement('div');
    const optionsDiv = document.createElement('div');
    optionsDiv.className = 'quiz-options';
    const scoreDiv = document.createElement('div');
    scoreDiv.style.marginTop = '10px';
    container.appendChild(questionDiv);
    container.appendChild(optionsDiv);
    container.appendChild(scoreDiv);

    function nextQuestion() {
      if (current >= shuffled.length) {
        questionDiv.textContent = `âœ… Quiz complete! You scored ${score} out of ${shuffled.length}.`;
        optionsDiv.innerHTML = `<button class="quiz" onclick="this.parentElement.parentElement.style.display='none'">Close</button>`;
        return;
      }

      const q = shuffled[current];
      let questionText, correctAnswer, answerOptions;

      // Decide question/answer direction
      let direction = mode;
      if (mode === 'mix') direction = Math.random() > 0.5 ? 'pt-en' : 'en-pt';

      if (direction === 'pt-en') {
        questionText = q.pt;
        correctAnswer = q.en;
        answerOptions = generateOptions(q.en, phrases.map(p => p.en));
      } else {
        questionText = q.en;
        correctAnswer = q.pt;
        answerOptions = generateOptions(q.pt, phrases.map(p => p.pt));
      }

      questionDiv.className = 'quiz-question';
      questionDiv.textContent = questionText;
      optionsDiv.innerHTML = '';

      answerOptions.forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.addEventListener('click', () => {
          if (opt === correctAnswer) {
            btn.classList.add('correct');
            score++;
          } else {
            btn.classList.add('wrong');
          }
          setTimeout(() => {
            current++;
            nextQuestion();
          }, 800);
        });
        optionsDiv.appendChild(btn);
      });

      scoreDiv.textContent = `Question ${current + 1} of ${shuffled.length}`;
    }

    nextQuestion();
  }

  function generateOptions(correct, pool) {
    const options = new Set([correct]);
    while (options.size < 4) {
      const rand = pool[Math.floor(Math.random() * pool.length)];
      options.add(rand);
    }
    return Array.from(options).sort(() => Math.random() - 0.5);
  }

  // Global quiz button
  document.getElementById('globalQuizBtn').addEventListener('click', () => {
    showQuizModeSelector(null, null, true);
  });
  // --- Download Section Audio (ZIP) ---
  async function downloadSection(section, headerElement) {
    const zip = new JSZip();
    const progressMsg = headerElement.nextElementSibling;
    const downloadBtn = headerElement.querySelector('.download');

    progressMsg.textContent = 'Preparing ZIP...';
    downloadBtn.disabled = true;

    const total = section.phrases.length;
    let count = 0;

    for (const ph of section.phrases) {
      const fileName = ph.pt.replace(/[^\w\s]/gi, '').replace(/\s+/g, '_') + '.mp3';
      const url = 'audio/' + ph.id + '.mp3';
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('File not found');
        const blob = await response.blob();
        zip.file(fileName, blob);
        count++;
        const percent = Math.round((count / total) * 100);
        progressMsg.textContent = `Preparing ZIP... ${percent}%`;
      } catch (err) {
        console.error(`Error fetching ${url}:`, err);
        progressMsg.textContent = `âš ï¸ Missing file: ${ph.id}.mp3`;
      }
    }

    const content = await zip.generateAsync({ type: 'blob' }, metadata => {
      const pct = Math.round(metadata.percent || 0);
      progressMsg.textContent = `Compressing... ${pct}%`;
    });

    saveAs(content, section.title.replace(/\s+/g, '_') + '.zip');
    progressMsg.textContent = 'âœ… Download ready!';
    downloadBtn.classList.add('done');
    downloadBtn.disabled = false;

    setTimeout(() => {
      progressMsg.textContent = '';
      downloadBtn.classList.remove('done');
    }, 4000);
  }
  </script>
</body>
</html>

